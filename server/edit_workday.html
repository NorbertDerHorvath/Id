<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Workday</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Edit Workday Event</h2>
        <form id="edit-workday-form">
            <div class="form-row">
                <div class="form-group col-md-6"><label>Start Time</label><input type="datetime-local" class="form-control" id="start-time"></div>
                <div class="form-group col-md-6"><label>End Time</label><input type="datetime-local" class="form-control" id="end-time"></div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6"><label>Start Location</label><input type="text" class="form-control" id="start-location"></div>
                <div class="form-group col-md-6"><label>End Location</label><input type="text" class="form-control" id="end-location"></div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-3"><label>Car Plate</label><input type="text" class="form-control" id="car-plate"></div>
                <div class="form-group col-md-3"><label>Start Odometer</label><input type="number" class="form-control" id="start-odo"></div>
                <div class="form-group col-md-3"><label>End Odometer</label><input type="number" class="form-control" id="end-odo"></div>
                <div class="form-group col-md-3"><label>Break (min)</label><input type="number" class="form-control" id="break-time"></div>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="/dashboard" class="btn btn-secondary">Cancel</a>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/login.html'; return; }

            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (!eventId) { alert('No event ID specified.'); window.location.href = '/dashboard'; return; }

            const getVal = id => document.getElementById(id).value;
            const getNumVal = id => getVal(id) ? parseFloat(getVal(id)) : null;
            const setVal = (id, value) => { if (document.getElementById(id)) document.getElementById(id).value = value; };
            const formatForInput = (date) => date ? new Date(date).toISOString().slice(0, 16) : '';

            try {
                const res = await fetch(`/api/workday-events/${eventId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to load event data.');
                
                const event = await res.json();

                setVal('start-time', formatForInput(event.startTime));
                setVal('end-time', formatForInput(event.endTime));
                setVal('start-location', event.startLocation || '');
                setVal('end-location', event.endLocation || '');
                setVal('car-plate', event.carPlate || '');
                setVal('start-odo', event.startOdometer || '');
                setVal('end-odo', event.endOdometer || '');
                setVal('break-time', event.breakTime || '');

            } catch (error) {
                alert(error.message);
                window.location.href = '/dashboard';
            }

            document.getElementById('edit-workday-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedEvent = {
                    startTime: getVal('start-time') || null,
                    endTime: getVal('end-time') || null,
                    startLocation: getVal('start-location') || null,
                    endLocation: getVal('end-location') || null,
                    carPlate: getVal('car-plate') || null,
                    startOdometer: getNumVal('start-odo'),
                    endOdometer: getNumVal('end-odo'),
                    breakTime: getNumVal('break-time')
                };

                try {
                    const res = await fetch(`/api/workday-events/${eventId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(updatedEvent)
                    });
                    if (!res.ok) throw new Error('Failed to save changes.');
                    window.location.href = '/dashboard';
                } catch (error) {
                    alert(error.message);
                }
            });
        });
    </script>
</body>
</html>