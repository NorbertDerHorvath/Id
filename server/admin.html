<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">... </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>User Management</h2>
            <div>
                <button id="debug-btn" class="btn btn-secondary mr-2" style="display: none;">Get Debug Data</button>
                <button id="merge-companies-btn" class="btn btn-warning mr-2" style="display: none;">Merge Duplicate Companies</button>
                <button class="btn btn-primary" data-toggle="modal" data-target="#userModal" onclick="prepareNewUserModal()">Add New User</button>
            </div>
        </div>
        <table class="table table-striped">... </table>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">...</div>

    <!-- Debug Modal -->
    <div class="modal fade" id="debugModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Debug Data</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <p>Copy the JSON data below and provide it for analysis.</p>
                    <textarea id="debug-data-textarea" class="form-control" rows="20" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let currentUserRole = null;

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!token) { window.location.href = '/login.html'; return; }
            const decodedToken = parseJwt(token);
            if (!decodedToken) { window.location.href = '/login.html'; return; }
            currentUserRole = decodedToken.role;

            if (currentUserRole === 'superadmin') {
                document.getElementById('merge-companies-btn').style.display = 'inline-block';
                document.getElementById('debug-btn').style.display = 'inline-block';
            }

            loadUsers();
            
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                window.location.href = '/login.html';
            });
            
            document.getElementById('merge-companies-btn').addEventListener('click', async () => {
                 if (!confirm('Are you sure you want to merge duplicate companies? This action cannot be undone.')) return;
                try {
                    const response = await fetch('/api/admin/merge-companies', { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } });
                    const resultText = await response.text(); 
                    alert(resultText || 'Merge process finished.');
                    loadUsers();
                } catch (error) {
                    alert('Error merging companies: ' + error.message);
                }
            });

            document.getElementById('debug-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/admin/debug-dump', { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    document.getElementById('debug-data-textarea').value = JSON.stringify(data, null, 2);
                    $('#debugModal').modal('show');
                } catch (error) {
                    alert('Error fetching debug data: ' + error.message);
                }
            });
        });

        async function loadUsers() { /* ... unchanged ... */ }
        function prepareNewUserModal() { /* ... unchanged ... */ }
        function prepareEditUserModal(user) { /* ... unchanged ... */ }
        document.getElementById('user-form').addEventListener('submit', async function(e) { /* ... unchanged ... */ });
    </script>
</body>
</html>