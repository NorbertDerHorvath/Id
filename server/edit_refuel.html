<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Refuel</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Edit Refuel Event</h2>
        <form id="edit-refuel-form">
            <div class="form-row">
               <div class="form-group col-md-4"><label>Date</label><input type="datetime-local" class="form-control" id="refuel-date"></div>
               <div class="form-group col-md-4"><label>Odometer</label><input type="number" class="form-control" id="refuel-odo"></div>
               <div class="form-group col-md-4"><label>Amount (L)</label><input type="number" step="0.01" class="form-control" id="refuel-amount"></div>
            </div>
             <div class="form-row">
               <div class="form-group col-md-4"><label>Fuel Type</label><input type="text" class="form-control" id="refuel-type"></div>
               <div class="form-group col-md-4"><label>Price</label><input type="number" step="0.01" class="form-control" id="refuel-price"></div>
               <div class="form-group col-md-4"><label>Payment</label><input type="text" class="form-control" id="refuel-payment"></div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6"><label>Location</label><input type="text" class="form-control" id="refuel-location"></div>
                <div class="form-group col-md-6"><label>Car Plate</label><input type="text" class="form-control" id="car-plate"></div>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="/dashboard" class="btn btn-secondary">Cancel</a>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/login.html'; return; }

            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            if (!eventId) { alert('No event ID specified.'); window.location.href = '/dashboard'; return; }

            const getVal = id => document.getElementById(id).value;
            const getNumVal = id => getVal(id) ? parseFloat(getVal(id)) : null;
            const setVal = (id, value) => { if (document.getElementById(id)) document.getElementById(id).value = value; };
            const formatForInput = (date) => date ? new Date(date).toISOString().slice(0, 16) : '';

            try {
                const res = await fetch(`/api/refuel-events/${eventId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to load event data.');
                
                const event = await res.json();

                setVal('refuel-date', formatForInput(event.timestamp));
                setVal('refuel-odo', event.odometer || '');
                setVal('refuel-amount', event.fuelAmount || '');
                setVal('refuel-type', event.fuelType || '');
                setVal('refuel-price', event.value || '');
                setVal('refuel-payment', event.paymentMethod || '');
                setVal('refuel-location', event.location || '');
                setVal('car-plate', event.carPlate || '');

            } catch (error) {
                alert(error.message);
                window.location.href = '/dashboard';
            }

            document.getElementById('edit-refuel-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedEvent = {
                    timestamp: getVal('refuel-date') || null,
                    odometer: getNumVal('refuel-odo'),
                    fuelAmount: getNumVal('refuel-amount'),
                    fuelType: getVal('refuel-type') || null,
                    value: getNumVal('refuel-price'),
                    paymentMethod: getVal('refuel-payment') || null,
                    location: getVal('refuel-location') || null,
                    carPlate: getVal('car-plate') || null
                };

                try {
                    const res = await fetch(`/api/refuel-events/${eventId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(updatedEvent)
                    });
                    if (!res.ok) throw new Error('Failed to save changes.');
                    window.location.href = '/dashboard';
                } catch (error) {
                    alert(error.message);
                }
            });
        });
    </script>
</body>
</html>