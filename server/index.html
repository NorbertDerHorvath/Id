<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Idő - Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { font-size: 0.875rem; }
        .table-responsive { max-height: 400px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/dashboard">Idő Dashboard</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto" id="nav-links">
                <li class="nav-item active"><a class="nav-link" href="/dashboard">Home</a></li>
            </ul>
            <ul class="navbar-nav ml-auto">
                 <li class="nav-item"><span class="navbar-text mr-3">Welcome, <span id="username-display"></span>!</span></li>
                <li class="nav-item"><button id="logout-btn" class="btn btn-danger">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <h4>Filters</h4>
        <form class="form-row align-items-end">
            <div class="form-group col-md-3">
                <label for="start-date">Start Date</label>
                <input type="date" class="form-control" id="start-date">
            </div>
            <div class="form-group col-md-3">
                <label for="end-date">End Date</label>
                <input type="date" class="form-control" id="end-date">
            </div>
             <div class="form-group col-md-2" id="company-filter-container" style="display: none;">
                <label for="company-filter">Company</label>
                <select id="company-filter" class="form-control"></select>
            </div>
            <div class="form-group col-md-2" id="user-filter-container" style="display: none;">
                <label for="user-filter">User</label>
                <select id="user-filter" class="form-control"></select>
            </div>
            <div class="form-group col-auto">
                <button type="button" id="filter-btn" class="btn btn-primary">Apply Filters</button>
                <button type="button" id="manual-entry-btn" class="btn btn-info" data-toggle="modal" data-target="#manualEntryModal" style="display:none;">Manual Entry</button>
            </div>
        </form>

        <hr>
        <div id="workday-section">
            <h4>Workday Events</h4>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead id="workday-table-head"></thead>
                    <tbody id="workday-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="refuel-section" class="mt-4">
            <h4>Refuel Events</h4>
            <div class="table-responsive">
                 <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th data-role-display="admin,superadmin">User</th>
                            <th>Dátum</th>
                            <th data-field="refuel_location">Helyszín</th>
                            <th data-field="refuel_odometer">Kilométeróra</th>
                            <th data-field="workday_carPlate">Rendszám</th>
                            <th data-field="refuel_fuelType">Üzemanyag</th>
                            <th>Mennyiség (L)</th>
                            <th data-field="refuel_price">Ár</th>
                            <th data-field="refuel_paymentMethod">Fizetési mód</th>
                            <th>Átlagfogy.</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="refuel-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
<!-- Manual Entry Modal -->
<div class="modal fade" id="manualEntryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manual Data Entry</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" id="manual-user-select-container" style="display: none;">
                    <label for="manual-user-select"><b>Target User (for this entry)</b></label>
                    <select id="manual-user-select" class="form-control"></select>
                </div>
                <hr>
                <div id="manual-workday-section">
                    <h6>Workday Entry</h6>
                    <form id="manual-work-form">
                        <div class="form-row">
                            <div class="form-group col-md-6" data-field="workday_startTime"><label>Start Time</label><input type="datetime-local" class="form-control" id="manual-start-time"></div>
                            <div class="form-group col-md-6" data-field="workday_endTime"><label>End Time</label><input type="datetime-local" class="form-control" id="manual-end-time"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6" data-field="workday_startLocation"><label>Start Location</label><input type="text" class="form-control" id="manual-start-location"></div>
                            <div class="form-group col-md-6" data-field="workday_endLocation"><label>End Location</label><input type="text" class="form-control" id="manual-end-location"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-3" data-field="workday_carPlate"><label>Car Plate</label><input type="text" class="form-control" id="manual-car-plate"></div>
                            <div class="form-group col-md-3" data-field="workday_startOdometer"><label>Start Odometer</label><input type="number" class="form-control" id="manual-start-odo"></div>
                            <div class="form-group col-md-3" data-field="workday_endOdometer"><label>End Odometer</label><input type="number" class="form-control" id="manual-end-odo"></div>
                            <div class="form-group col-md-3" data-field="workday_breakTime"><label>Break (min)</label><input type="number" class="form-control" id="manual-break" value="0"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Workday</button>
                    </form>
                </div>
                <hr>
                 <div id="manual-absence-section">
                    <h6>Távollét / Ünnepnap</h6>
                    <form id="manual-absence-form">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="absence-date">Dátum</label>
                                <input type="date" id="absence-date" class="form-control">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="absence-type">Típus</label>
                                <select id="absence-type" class="form-control">
                                    <option value="vacation">Szabadság</option>
                                    <option value="sick_leave">Betegállomány</option>
                                    <option value="paid_holiday">Fizetett ünnep</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Absence</button>
                    </form>
                </div>
                <hr id="manual-separator">
                <div id="manual-refuel-section">
                    <h6>Refuel Entry</h6>
                    <form id="manual-refuel-form">
                        <div class="form-row">
                           <div class="form-group col-md-4"><label>Date</label><input type="datetime-local" class="form-control" id="manual-refuel-date"></div>
                           <div class="form-group col-md-4" data-field="refuel_odometer"><label>Odometer</label><input type="number" class="form-control" id="manual-refuel-odo"></div>
                           <div class="form-group col-md-4"><label>Amount (L)</label><input type="number" step="0.01" class="form-control" id="manual-refuel-amount"></div>
                        </div>
                         <div class="form-row">
                           <div class="form-group col-md-4" data-field="refuel_fuelType"><label>Fuel Type</label><input type="text" class="form-control" id="manual-refuel-type"></div>
                           <div class="form-group col-md-4" data-field="refuel_price"><label>Price (<span class="currency-symbol"></span>)</label><input type="number" step="0.01" class="form-control" id="manual-refuel-price"></div>
                           <div class="form-group col-md-4" data-field="refuel_paymentMethod"><label>Payment</label><input type="text" class="form-control" id="manual-refuel-payment"></div>
                        </div>
                         <div class="form-row">
                            <div class="form-group col-md-4" data-field="refuel_location"><label>Location</label><input type="text" class="form-control" id="manual-refuel-location"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Refuel</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let currentUser = null;
        let allUsers = [];
        let companySettings = {};

        const eventTypeLabels = {
            workday: 'Munkanap',
            vacation: 'Szabadság',
            sick_leave: 'Betegállomány',
            paid_holiday: 'Fizetett ünnep'
        };

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/login.html'; return; }
            
            currentUser = parseJwt(token);
            if (!currentUser) { window.location.href = '/login.html'; return; }
            
            document.getElementById('username-display').textContent = localStorage.getItem('username') || 'User';

            await loadCompanySettings();
            setupRoleBasedUI();

            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                 await populateUserFilter();
            }
             if (currentUser.role === 'superadmin') {
                await populateCompanyFilter();
            }

            document.getElementById('filter-btn').addEventListener('click', fetchData);
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = '/login.html';
            });

            document.getElementById('manual-work-form').addEventListener('submit', handleManualWorkdaySubmit);
            document.getElementById('manual-refuel-form').addEventListener('submit', handleManualRefuelSubmit);
            document.getElementById('manual-absence-form').addEventListener('submit', handleManualAbsenceSubmit);

            await fetchData();
        });

        function setupRoleBasedUI() {
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                document.getElementById('user-filter-container').style.display = 'block';
                document.getElementById('manual-entry-btn').style.display = 'inline-block';
                document.getElementById('manual-user-select-container').style.display = 'block';

                const navLinks = document.getElementById('nav-links');
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>';
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/settings">Settings</a></li>';
            }

            if (currentUser.role === 'superadmin') {
                document.getElementById('company-filter-container').style.display = 'block';
            }

            document.querySelectorAll('[data-role-display]').forEach(el => {
                const roles = el.getAttribute('data-role-display').split(',');
                el.style.display = roles.includes(currentUser.role) ? '' : 'none';
            });
        }

        async function loadCompanySettings() {
             try {
                const res = await fetch('/api/my-settings', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                companySettings = res.ok ? await res.json() : { fields: {} };
            } catch (e) {
                console.error('Could not load company settings', e);
                companySettings = { fields: {} };
            }
        }
        
        function applyFieldSettings() {
            const { fields } = companySettings;
            if (!fields) return;

            document.querySelectorAll('[data-field]').forEach(el => {
                const key = el.getAttribute('data-field');
                let show = fields[key] !== false;
                if (key === 'workday_endOdometer' && (el.tagName === 'TH' || el.tagName === 'TD')) {
                    show = fields['workday_startOdometer'] && fields['workday_endOdometer'];
                }
                el.style.display = show ? '' : 'none';
            });
            
            const isAnyWorkdayFieldEnabled = Object.keys(fields).some(key => key.startsWith('workday_') && fields[key]);
            document.getElementById('workday-section').style.display = isAnyWorkdayFieldEnabled ? '' : 'none';
             document.getElementById('manual-workday-section').style.display = isAnyWorkdayFieldEnabled ? '' : 'none';

            const isAnyRefuelFieldEnabled = Object.keys(fields).some(key => key.startsWith('refuel_') && fields[key]);
            document.getElementById('refuel-section').style.display = isAnyRefuelFieldEnabled ? '' : 'none';
            document.getElementById('manual-refuel-section').style.display = isAnyRefuelFieldEnabled ? '' : 'none';
            
            document.getElementById('manual-separator').style.display = isAnyWorkdayFieldEnabled && isAnyRefuelFieldEnabled ? '' : 'none';

            document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = companySettings.currency || 'Ft');
        }

        async function fetchData() {
            await Promise.all([loadWorkdayEvents(), loadRefuelEvents()]);
            applyFieldSettings();
        }

        async function populateCompanyFilter() {
            try {
                const res = await fetch('/api/admin/companies', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                const companies = await res.json();
                const filter = document.getElementById('company-filter');
                filter.innerHTML = '<option value="all">All Companies</option>';
                companies.forEach(c => { filter.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
            } catch(e) { console.error(e); }
        }

        async function populateUserFilter() {
             try {
                const res = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                allUsers = await res.json();
                const userFilter = document.getElementById('user-filter');
                const manualUserSelect = document.getElementById('manual-user-select');

                userFilter.innerHTML = '<option value="all">All Users</option>';
                manualUserSelect.innerHTML = '';

                allUsers.forEach(u => { 
                    const option = `<option value="${u.id}">${u.realName || u.username}</option>`;
                    userFilter.innerHTML += option;
                    manualUserSelect.innerHTML += option;
                });
            } catch(e) { console.error(e); }
        }

        async function loadWorkdayEvents() {
            const tableHead = document.getElementById('workday-table-head');
            const tableBody = document.getElementById('workday-table-body');
            tableHead.innerHTML = `<tr>
                <th data-role-display="admin,superadmin">User</th>
                <th>Típus</th>
                <th>Dátum</th>
                <th data-field="workday_carPlate">Rendszám</th>
                <th data-field="workday_startTime">Indulás</th>
                <th data-field="workday_endTime">Érkezés</th>
                <th data-field="workday_breakTime">Szünet</th>
                <th>Nettó idő</th>
                <th data-field="workday_endOdometer">Táv</th>
                <th>Actions</th>
            </tr>`;
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center">Loading...</td></tr>';
            
            const params = new URLSearchParams();
            if(document.getElementById('start-date').value) params.append('startDate', document.getElementById('start-date').value);
            if(document.getElementById('end-date').value) params.append('endDate', document.getElementById('end-date').value);
            if(currentUser.role === 'admin' || currentUser.role === 'superadmin'){
                if(document.getElementById('user-filter')?.value !== 'all') params.append('userId', document.getElementById('user-filter').value);
            }
            if(currentUser.role === 'superadmin' && document.getElementById('company-filter')?.value !== 'all') {
                params.append('companyId', document.getElementById('company-filter').value);
            }

            try {
                const res = await fetch(`/api/workday-events?${params}` , { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error((await res.json()).error);
                const events = await res.json();
                tableBody.innerHTML = '';
                if(events.length === 0) tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No data found.</td></tr>';

                events.forEach(e => {
                    let rowHtml = '';
                    const actions = (currentUser.role === 'superadmin' || e.userId === currentUser.userId) ? 
                        `<td>
                            <button class="btn btn-sm btn-info" onclick="window.location.href='/edit_workday.html?id=${e.id}'">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWorkdayEvent('${e.id}')">Delete</button>
                        </td>` : '<td></td>';

                    if (e.eventType === 'workday') {
                        const start = new Date(e.startTime);
                        const end = e.endTime ? new Date(e.endTime) : null;
                        const netTime = end ? (end - start) - (e.breakTime * 60000) : 0;
                        rowHtml = `
                            <tr>
                                <td data-role-display="admin,superadmin">${e.User?.realName || e.User?.username}</td>
                                <td>${eventTypeLabels[e.eventType]}</td>
                                <td>${start.toLocaleDateString()}</td>
                                <td data-field="workday_carPlate">${e.carPlate || '-'}</td>
                                <td data-field="workday_startTime">${start.toLocaleTimeString()} (${e.startLocation || '-'} / ${e.startOdometer || '-'} km)</td>
                                <td data-field="workday_endTime">${end ? `${end.toLocaleTimeString()} (${e.endLocation || '-'} / ${e.endOdometer || '-'} km)` : 'Ongoing'}</td>
                                <td data-field="workday_breakTime">${e.breakTime || 0} min</td>
                                <td>${new Date(netTime).toISOString().substr(11, 8)}</td>
                                <td data-field="workday_endOdometer">${e.startOdometer && e.endOdometer ? e.endOdometer - e.startOdometer : '-'} km</td>
                                ${actions}
                            </tr>
                        `;
                    } else {
                         rowHtml = `
                            <tr>
                                <td data-role-display="admin,superadmin">${e.User?.realName || e.User?.username}</td>
                                <td>${eventTypeLabels[e.eventType]}</td>
                                <td>${new Date(e.startTime).toLocaleDateString()}</td>
                                <td colspan="6" class="text-center font-italic">-</td>
                                ${actions}
                            </tr>
                        `;
                    }
                    tableBody.innerHTML += rowHtml;
                });
                applyFieldSettings(); // Re-apply to hide/show columns
            } catch (e) { tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">${e.message}</td></tr>`; }
        }

        async function deleteWorkdayEvent(id) {
            if (!confirm('Are you sure you want to delete this workday event?')) return;
            try {
                const res = await fetch(`/api/workday-events/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error((await res.json()).error);
                fetchData();
            } catch (e) { alert(e.message); }
        }

        async function loadRefuelEvents() {
            const tableBody = document.getElementById('refuel-table-body');
            tableBody.innerHTML = '<tr><td colspan="11" class="text-center">Loading...</td></tr>';
            
            const params = new URLSearchParams();
             if(document.getElementById('start-date').value) params.append('startDate', document.getElementById('start-date').value);
            if(document.getElementById('end-date').value) params.append('endDate', document.getElementById('end-date').value);
            if(currentUser.role === 'admin' || currentUser.role === 'superadmin'){
                if(document.getElementById('user-filter')?.value !== 'all') params.append('userId', document.getElementById('user-filter').value);
            }
             if(currentUser.role === 'superadmin' && document.getElementById('company-filter')?.value !== 'all') {
                params.append('companyId', document.getElementById('company-filter').value);
            }

            try {
                const res = await fetch(`/api/refuel-events?${params}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error((await res.json()).error);
                const events = await res.json();
                tableBody.innerHTML = '';
                if(events.length === 0) tableBody.innerHTML = '<tr><td colspan="11" class="text-center">No data found.</td></tr>';
                
                events.forEach(e => {
                    const actions = (currentUser.role === 'superadmin' || e.userId === currentUser.userId) ? 
                        `<td>
                            <button class="btn btn-sm btn-info" onclick="window.location.href='/edit_refuel.html?id=${e.id}'">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRefuelEvent('${e.id}')">Delete</button>
                        </td>` : '<td></td>';

                    tableBody.innerHTML += `
                        <tr>
                            <td data-role-display="admin,superadmin">${e.User?.realName || e.User?.username}</td>
                            <td>${new Date(e.timestamp).toLocaleString()}</td>
                            <td data-field="refuel_location">${e.location || '-'}</td>
                            <td data-field="refuel_odometer">${e.odometer} km</td>
                            <td data-field="workday_carPlate">${e.carPlate || '-'}</td>
                            <td data-field="refuel_fuelType">${e.fuelType}</td>
                            <td>${e.fuelAmount} L</td>
                            <td data-field="refuel_price">${e.value ? e.value.toFixed(2) + ' ' + (companySettings.currency || 'Ft') : '-'}</td>
                            <td data-field="refuel_paymentMethod">${e.paymentMethod}</td>
                            <td>-</td>
                            ${actions}
                        </tr>
                    `;
                });

            } catch (e) { tableBody.innerHTML = `<tr><td colspan="11" class="text-center text-danger">${e.message}</td></tr>`; }
        }

        async function deleteRefuelEvent(id) {
            if (!confirm('Are you sure you want to delete this refuel event?')) return;
            try {
                const res = await fetch(`/api/refuel-events/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error((await res.json()).error);
                fetchData();
            } catch (e) { alert(e.message); }
        }
        
        async function handleManualWorkdaySubmit(e) {
            e.preventDefault();
            let userId = currentUser.userId;
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                userId = document.getElementById('manual-user-select').value;
            }
            const getVal = id => document.getElementById(id).value;
            const getNumVal = id => getVal(id) ? parseFloat(getVal(id)) : null;

            const body = {
                userId,
                companyId: currentUser.companyId, // Make sure to include companyId
                eventType: 'workday',
                startTime: getVal('manual-start-time') || null,
                endTime: getVal('manual-end-time') || null,
                startLocation: getVal('manual-start-location'),
                endLocation: getVal('manual-end-location'),
                carPlate: getVal('manual-car-plate'),
                startOdometer: getNumVal('manual-start-odo'),
                endOdometer: getNumVal('manual-end-odo'),
                breakTime: getNumVal('manual-break'),
            };

            try {
                const res = await fetch('/api/workday-events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: JSON.stringify(body)
                });
                if(!res.ok) throw new Error((await res.json()).error);
                $('#manualEntryModal').modal('hide');
                document.getElementById('manual-work-form').reset();
                fetchData();
            } catch(e) { alert('Error: ' + e.message); }
        }
        
        async function handleManualAbsenceSubmit(e) {
            e.preventDefault();
             let userId = currentUser.userId;
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                userId = document.getElementById('manual-user-select').value;
            }
             const body = {
                userId,
                companyId: currentUser.companyId, // Make sure to include companyId
                eventType: document.getElementById('absence-type').value,
                startTime: document.getElementById('absence-date').value
            };
             try {
                const res = await fetch('/api/workday-events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: JSON.stringify(body)
                });
                if(!res.ok) throw new Error((await res.json()).error);
                $('#manualEntryModal').modal('hide');
                 document.getElementById('manual-absence-form').reset();
                fetchData();
            } catch(e) { alert('Error: ' + e.message); }

        }

        async function handleManualRefuelSubmit(e) {
            e.preventDefault();
            let userId = currentUser.userId;
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                userId = document.getElementById('manual-user-select').value;
            }
             const getVal = id => document.getElementById(id).value;
             const getNumVal = id => getVal(id) ? parseFloat(getVal(id)) : null;

             const body = {
                userId,
                companyId: currentUser.companyId, // Make sure to include companyId
                timestamp: getVal('manual-refuel-date') || null,
                odometer: getNumVal('manual-refuel-odo'),
                fuelType: getVal('manual-refuel-type'),
                fuelAmount: getNumVal('manual-refuel-amount'),
                value: getNumVal('manual-refuel-price'), // Corrected key
                paymentMethod: getVal('manual-refuel-payment'),
                location: getVal('manual-refuel-location')
            };
            try {
                const res = await fetch('/api/refuel-events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: JSON.stringify(body)
                });
                if(!res.ok) throw new Error((await res.json()).error);
                $('#manualEntryModal').modal('hide');
                document.getElementById('manual-refuel-form').reset();
                fetchData();
            } catch(e) { alert('Error: ' + e.message); }
        }

    </script>
</body>
</html>
