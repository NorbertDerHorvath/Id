<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Idő - Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .event-card { margin-bottom: 1rem; }
        .navbar { margin-bottom: 2rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Idő Dashboard</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto" id="nav-links">
                <li class="nav-item active"><a class="nav-link" href="/dashboard">Home</a></li>
            </ul>
            <ul class="navbar-nav ml-auto">
                 <li class="nav-item"><span class="navbar-text mr-3">Welcome, <span id="username-display"></span>!</span></li>
                <li class="nav-item"><button id="logout-btn" class="btn btn-danger">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h2>Workday Events</h2>
                <div id="workday-events"></div>
            </div>
            <div class="col-md-6">
                <h2>Refuel Events</h2>
                <div id="refuel-events"></div>
            </div>
        </div>
    </div>

    <script>
         function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html'; 
                return;
            }
            document.getElementById('username-display').textContent = localStorage.getItem('username') || 'User';

            const decodedToken = parseJwt(token);
            if (decodedToken && (decodedToken.role === 'admin' || decodedToken.role === 'superadmin')) {
                const navLinks = document.getElementById('nav-links');
                const adminLi = document.createElement('li');
                adminLi.className = 'nav-item';
                adminLi.innerHTML = `<a class="nav-link" href="/admin">Admin</a>`;
                navLinks.appendChild(adminLi);
            }

            fetchEvents('/api/workday-events', 'workday-events', formatWorkdayEvent, token);
            fetchEvents('/api/refuel-events', 'refuel-events', formatRefuelEvent, token);

            document.getElementById('logout-btn').addEventListener('click', () => {
                fetch('/api/logout', { method: 'POST' })
                .finally(() => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    window.location.href = '/login.html';
                });
            });
        });

        async function fetchEvents(url, elementId, formatter, token) {
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 403 || response.status === 401) {
                    localStorage.clear();
                    window.location.href = '/login.html';
                }
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const events = await response.json();
                const container = document.getElementById(elementId);
                container.innerHTML = '';
                events.forEach(event => {
                    const card = document.createElement('div');
                    card.className = 'card event-card';
                    card.innerHTML = formatter(event);
                    container.appendChild(card);
                });
            } catch (error) {
                console.error(`Failed to fetch events from ${url}:`, error);
                document.getElementById(elementId).innerHTML = `<p class="text-danger">Error loading events. Please try again later.</p>`;
            }
        }

        function formatWorkdayEvent(event) {
            return `
                <div class="card-body">
                    <h5 class="card-title">Workday by ${event.User ? event.User.username : 'N/A'}</h5>
                    <p class="card-text">Car: ${event.carPlate || 'N/A'}</p>
                    <p class="card-text">Starts: ${new Date(event.startTime).toLocaleString()}</p>
                    <p class="card-text">Ends: ${event.endTime ? new Date(event.endTime).toLocaleString() : 'Ongoing'}</p>
                    <a href="/edit_workday.html?id=${event.id}" class="btn btn-primary">Edit</a>
                </div>
            `;
        }

        function formatRefuelEvent(event) {
            return `
                <div class="card-body">
                    <h5 class="card-title">Refuel by ${event.User ? event.User.username : 'N/A'}</h5>
                     <p class="card-text">Car: ${event.carPlate || 'N/A'}</p>
                    <p class="card-text">Amount: ${event.fuelAmount}L of ${event.fuelType}</p>
                    <p class="card-text">Date: ${new Date(event.timestamp).toLocaleString()}</p>
                    <a href="/edit_refuel.html?id=${event.id}" class="btn btn-primary">Edit</a>
                </div>
            `;
        }
    </script>
</body>
</html>
