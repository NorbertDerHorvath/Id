<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Idő - Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { font-size: 0.875rem; }
        .table-responsive { max-height: 400px; }
        th, td { white-space: nowrap; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/dashboard">Idő Dashboard</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto" id="nav-links">
                <li class="nav-item active"><a class="nav-link" href="/dashboard">Home</a></li>
            </ul>
            <ul class="navbar-nav ml-auto">
                 <li class="nav-item"><span class="navbar-text mr-3">Welcome, <span id="username-display"></span>!</span></li>
                <li class="nav-item"><button id="logout-btn" class="btn btn-danger">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div id="main-content">
            <h4>Filters</h4>
            <form class="form-row align-items-end">
                <div class="form-group col-md-3">
                    <label for="start-date">Start Date</label>
                    <input type="date" class="form-control" id="start-date">
                </div>
                <div class="form-group col-md-3">
                    <label for="end-date">End Date</label>
                    <input type="date" class="form-control" id="end-date">
                </div>
                 <div class="form-group col-md-2" id="company-filter-container" style="display: none;">
                    <label for="company-filter">Company</label>
                    <select id="company-filter" class="form-control"></select>
                </div>
                <div class="form-group col-md-2" id="user-filter-container" style="display: none;">
                    <label for="user-filter">User</label>
                    <select id="user-filter" class="form-control"></select>
                </div>
                <div class="form-group col-auto">
                    <button type="button" id="filter-btn" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
    
            <hr>
    
            <h4>Workday Events</h4>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead id="workday-table-head"></thead>
                    <tbody id="workday-table-body"></tbody>
                </table>
            </div>
    
            <h4 class="mt-4">Refuel Events</h4>
            <div class="table-responsive">
                 <table class="table table-sm table-bordered">
                    <thead id="refuel-table-head"></thead>
                    <tbody id="refuel-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Edit Workday Modal -->
    <div class="modal fade" id="editWorkdayModal" tabindex="-1">...</div>

    <!-- Edit Refuel Modal -->
    <div class="modal fade" id="editRefuelModal" tabindex="-1">...</div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let currentUserRole = null;
        let currentSettings = {};
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!token) {
                window.location.href = '/login.html';
                return; 
            }
            main();
        });

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        async function main() {
            const decodedToken = parseJwt(token);
            if (!decodedToken) {
                localStorage.clear();
                window.location.href = '/login.html';
                return;
            }
            currentUserRole = decodedToken.role;
            document.getElementById('username-display').textContent = localStorage.getItem('username') || 'User';

            await loadSettings(decodedToken.companyId);

            if (currentUserRole === 'admin' || currentUserRole === 'superadmin') {
                const navLinks = document.getElementById('nav-links');
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>';
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/settings">Settings</a></li>';
                document.getElementById('user-filter-container').style.display = 'block';
                if (currentUserRole === 'superadmin') {
                    document.getElementById('company-filter-container').style.display = 'block';
                    await populateCompanyFilter();
                }
                await populateUserFilter(decodedToken.companyId);
            }

            document.getElementById('filter-btn').addEventListener('click', fetchData);
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = '/login.html';
            });

            fetchData();
        }
        
        async function loadSettings(companyId) {
             if (!companyId && currentUserRole !== 'superadmin') {
                 document.getElementById('main-content').innerHTML = `<div class="alert alert-danger"><b>Error:</b> User is not assigned to a company. Settings cannot be loaded.</div>`;
                 return;
            }
            try {
                const targetCompanyId = currentUserRole === 'superadmin' ? document.getElementById('company-filter')?.value : companyId;
                if (!targetCompanyId || targetCompanyId === 'all') {
                    currentSettings = { companySettings: { currency: 'HUF', visibleFields: {}, customFields: [] } };
                    return;
                }

                const res = await fetch(`/api/settings?companyId=${targetCompanyId}`, { headers: { 'Authorization': `Bearer ${token}` }});
                if (res.ok) {
                    currentSettings = await res.json();
                } else {
                    throw new Error('Could not load settings');
                }
            } catch (e) { 
                console.error(e);
            }
        }

        function fetchData() {
            renderHeaders();
            loadWorkdayEvents();
            loadRefuelEvents();
        }

        function renderHeaders() {
            const workdayHead = document.getElementById('workday-table-head');
            const refuelHead = document.getElementById('refuel-table-head');
            workdayHead.innerHTML = `<tr><th>User</th><th>Plate</th><th>Start</th><th>End</th><th>Breaks</th><th>Net Time</th><th>Distance</th><th>Actions</th></tr>`;
            refuelHead.innerHTML = `<tr><th>User</th><th>Date</th><th>Location</th><th>Odometer</th><th>Fuel Type</th><th>Amount (L)</th><th>Price</th><th>Payment</th><th>Avg. Cons.</th><th>Actions</th></tr>`;
        }

        async function populateCompanyFilter() { /* ... */ }
        async function populateUserFilter(companyId) { /* ... */ }
        async function loadWorkdayEvents() { /* ... */ }
        async function loadRefuelEvents() { /* ... */ }

        function openEditModal(eventData, type) {
            if (type === 'workday') {
                document.getElementById('edit-workday-id').value = eventData.id;
                document.getElementById('edit-start-time').value = new Date(eventData.startTime).toISOString().substring(0, 16);
                document.getElementById('edit-end-time').value = eventData.endTime ? new Date(eventData.endTime).toISOString().substring(0, 16) : '';
                document.getElementById('edit-car-plate').value = eventData.carPlate || '';
                // ... populate other fields
                $('#editWorkdayModal').modal('show');
            } else if (type === 'refuel') {
                // ... populate refuel modal fields
                $('#editRefuelModal').modal('show');
            }
        }

    </script>
</body>
</html>
