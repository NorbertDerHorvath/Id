<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Idő - Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { font-size: 0.875rem; }
        .table-responsive { max-height: 400px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/dashboard">Idő Dashboard</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto" id="nav-links">
                <li class="nav-item active"><a class="nav-link" href="/dashboard">Home</a></li>
            </ul>
            <ul class="navbar-nav ml-auto">
                 <li class="nav-item"><span class="navbar-text mr-3">Welcome, <span id="username-display"></span>!</span></li>
                <li class="nav-item"><button id="logout-btn" class="btn btn-danger">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <h4>Filters</h4>
        <form class="form-row align-items-end">
            <div class="form-group col-md-3">
                <label for="start-date">Start Date</label>
                <input type="date" class="form-control" id="start-date">
            </div>
            <div class="form-group col-md-3">
                <label for="end-date">End Date</label>
                <input type="date" class="form-control" id="end-date">
            </div>
             <div class="form-group col-md-2" id="company-filter-container" style="display: none;">
                <label for="company-filter">Company</label>
                <select id="company-filter" class="form-control"></select>
            </div>
            <div class="form-group col-md-2" id="user-filter-container" style="display: none;">
                <label for="user-filter">User</label>
                <select id="user-filter" class="form-control"></select>
            </div>
            <div class="form-group col-auto">
                <button type="button" id="filter-btn" class="btn btn-primary">Apply Filters</button>
                <button type="button" id="manual-entry-btn" class="btn btn-info" data-toggle="modal" data-target="#manualEntryModal" style="display:none;">Manual Entry</button>
            </div>
        </form>

        <hr>

        <h4>Workday Events</h4>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th data-role-display="admin,superadmin">User</th>
                        <th data-field="workday_carPlate">Plate</th>
                        <th data-field="workday_startTime">Start</th>
                        <th data-field="workday_endTime">End</th>
                        <th data-field="workday_breakTime">Breaks</th>
                        <th>Net Time</th>
                        <th data-field="workday_endOdometer">Distance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="workday-table-body"></tbody>
            </table>
        </div>

        <h4 class="mt-4">Refuel Events</h4>
        <div class="table-responsive">
             <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th data-role-display="admin,superadmin">User</th>
                        <th>Date</th>
                        <th data-field="refuel_location">Location</th>
                        <th data-field="refuel_odometer">Odometer</th>
                        <th data-field="workday_carPlate">Plate</th>
                        <th data-field="refuel_fuelType">Fuel Type</th>
                        <th>Amount (L)</th>
                        <th data-field="refuel_price">Price</th>
                        <th data-field="refuel_paymentMethod">Payment</th>
                        <th>Avg. Cons.</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="refuel-table-body"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Manual Entry Modal -->
<div class="modal fade" id="manualEntryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manual Data Entry</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" id="manual-user-select-container" style="display: none;">
                    <label for="manual-user-select"><b>Target User (for this entry)</b></label>
                    <select id="manual-user-select" class="form-control"></select>
                </div>
                <hr>
                <h6>Workday Entry</h6>
                <form id="manual-work-form">
                    <div class="form-row">
                        <div class="form-group col-md-6" data-field="workday_startTime"><label>Start Time</label><input type="datetime-local" class="form-control" id="manual-start-time"></div>
                        <div class="form-group col-md-6" data-field="workday_endTime"><label>End Time</label><input type="datetime-local" class="form-control" id="manual-end-time"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6" data-field="workday_startLocation"><label>Start Location</label><input type="text" class="form-control" id="manual-start-location"></div>
                        <div class="form-group col-md-6" data-field="workday_endLocation"><label>End Location</label><input type="text" class="form-control" id="manual-end-location"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-3" data-field="workday_carPlate"><label>Car Plate</label><input type="text" class="form-control" id="manual-car-plate"></div>
                        <div class="form-group col-md-3" data-field="workday_startOdometer"><label>Start Odometer</label><input type="number" class="form-control" id="manual-start-odo"></div>
                        <div class="form-group col-md-3" data-field="workday_endOdometer"><label>End Odometer</label><input type="number" class="form-control" id="manual-end-odo"></div>
                        <div class="form-group col-md-3" data-field="workday_breakTime"><label>Break (min)</label><input type="number" class="form-control" id="manual-break" value="0"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Workday</button>
                </form>
                <hr>
                <h6>Refuel Entry</h6>
                <form id="manual-refuel-form">
                    <div class="form-row">
                       <div class="form-group col-md-4"><label>Date</label><input type="datetime-local" class="form-control" id="manual-refuel-date" required></div>
                       <div class="form-group col-md-4" data-field="refuel_odometer"><label>Odometer</label><input type="number" class="form-control" id="manual-refuel-odo" required></div>
                       <div class="form-group col-md-4"><label>Amount (L)</label><input type="number" step="0.01" class="form-control" id="manual-refuel-amount" required></div>
                    </div>
                     <div class="form-row">
                       <div class="form-group col-md-4" data-field="refuel_fuelType"><label>Fuel Type</label><input type="text" class="form-control" id="manual-refuel-type"></div>
                       <div class="form-group col-md-4" data-field="refuel_price"><label>Price (<span class="currency-symbol"></span>)</label><input type="number" step="0.01" class="form-control" id="manual-refuel-price"></div>
                       <div class="form-group col-md-4" data-field="refuel_paymentMethod"><label>Payment</label><input type="text" class="form-control" id="manual-refuel-payment"></div>
                    </div>
                     <div class="form-row">
                        <div class="form-group col-md-4" data-field="refuel_location"><label>Location</label><input type="text" class="form-control" id="manual-refuel-location"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Refuel</button>
                </form>
            </div>
        </div>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let currentUser = null;
        let allUsers = [];
        let companySettings = {};

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/login.html'; return; }
            
            currentUser = parseJwt(token);
            if (!currentUser) { window.location.href = '/login.html'; return; }
            
            document.getElementById('username-display').textContent = localStorage.getItem('username') || 'User';

            await loadCompanySettings();
            setupRoleBasedUI();

            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                 await populateUserFilter();
            }
             if (currentUser.role === 'superadmin') {
                await populateCompanyFilter();
            }

            document.getElementById('filter-btn').addEventListener('click', fetchData);
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = '/login.html';
            });

            document.getElementById('manual-work-form').addEventListener('submit', handleManualWorkdaySubmit);
            document.getElementById('manual-refuel-form').addEventListener('submit', handleManualRefuelSubmit);

            await fetchData();
        });

        function setupRoleBasedUI() {
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                document.getElementById('user-filter-container').style.display = 'block';
                document.getElementById('manual-entry-btn').style.display = 'inline-block';
                document.getElementById('manual-user-select-container').style.display = 'block';

                const navLinks = document.getElementById('nav-links');
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>';
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/settings">Settings</a></li>';
            }

            if (currentUser.role === 'superadmin') {
                document.getElementById('company-filter-container').style.display = 'block';
            }

            document.querySelectorAll('[data-role-display]').forEach(el => {
                const roles = el.getAttribute('data-role-display').split(',');
                el.style.display = roles.includes(currentUser.role) ? '' : 'none';
            });
        }

        async function loadCompanySettings() {
             try {
                const res = await fetch('/api/my-settings', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                companySettings = res.ok ? await res.json() : { fields: {} };
            } catch (e) {
                console.error('Could not load company settings', e);
                companySettings = { fields: {} };
            }
        }
        
        function applyFieldSettings() {
            document.querySelectorAll('[data-field]').forEach(el => {
                const key = el.getAttribute('data-field');
                let show = companySettings.fields ? companySettings.fields[key] !== false : true;
                
                if (key === 'workday_endOdometer' && (el.tagName === 'TH' || el.tagName === 'TD')) {
                     show = companySettings.fields ? (companySettings.fields['workday_startOdometer'] && companySettings.fields['workday_endOdometer']) : true;
                }
                el.style.display = show ? '' : 'none';
            });
            document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = companySettings.currency || 'Ft');
        }

        async function fetchData() {
            await Promise.all([loadWorkdayEvents(), loadRefuelEvents()]);
            applyFieldSettings();
        }

        async function populateCompanyFilter() {
            try {
                const res = await fetch('/api/admin/companies', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                const companies = await res.json();
                const filter = document.getElementById('company-filter');
                filter.innerHTML = '<option value="all">All Companies</option>';
                companies.forEach(c => { filter.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
            } catch(e) { console.error(e); }
        }

        async function populateUserFilter() {
             try {
                const res = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                allUsers = await res.json();
                const userFilter = document.getElementById('user-filter');
                const manualUserSelect = document.getElementById('manual-user-select');

                userFilter.innerHTML = '<option value="all">All Users</option>';
                manualUserSelect.innerHTML = '';

                allUsers.forEach(u => { 
                    const option = `<option value="${u.id}">${u.realName || u.username}</option>`;
                    userFilter.innerHTML += option;
                    manualUserSelect.innerHTML += option;
                });
            } catch(e) { console.error(e); }
        }

        async function loadWorkdayEvents() {
            const tableBody = document.getElementById('workday-table-body');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Loading...</td></tr>';
            
            const params = new URLSearchParams();
            if(document.getElementById('start-date').value) params.append('startDate', document.getElementById('start-date').value);
            if(document.getElementById('end-date').value) params.append('endDate', document.getElementById('end-date').value);
            if(currentUser.role === 'admin' || currentUser.role === 'superadmin'){
                if(document.getElementById('user-filter')?.value !== 'all') params.append('userId', document.getElementById('user-filter').value);
            }
            if(currentUser.role === 'superadmin' && document.getElementById('company-filter')?.value !== 'all') {
                params.append('companyId', document.getElementById('company-filter').value);
            }

            try {
                const res = await fetch(`/api/workday-events?${params}` , { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error((await res.json()).error);
                const events = await res.json();
                tableBody.innerHTML = '';
                if(events.length === 0) tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No data found.</td></tr>';

                events.forEach(e => {
                    const start = new Date(e.startTime);
                    const end = e.endTime ? new Date(e.endTime) : null;
                    const netTime = end ? (end - start) - (e.breakTime * 60000) : 0;
                    const actions = (currentUser.role === 'superadmin' || e.userId === currentUser.userId) ? 
                        `<td>
                            <button class="btn btn-sm btn-info" onclick="window.location.href='/edit_workday.html?id=${e.id}'">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWorkdayEvent('${e.id}')">Delete</button>
                        </td>` : '<td></td>';

                    tableBody.innerHTML += `
                        <tr>
                            <td data-role-display="admin,superadmin">${e.User?.realName || e.User?.username}</td>
                            <td data-field="workday_carPlate">${e.carPlate || '-'}</td>
                            <td data-field="workday_startTime">${start.toLocaleString()} - ${e.startLocation || '-'} (${e.startOdometer || '-'} km)</td>
                            <td data-field="workday_endTime">${end ? `${end.toLocaleString()} - ${e.endLocation || '-'} (${e.endOdometer || '-'} km)` : 'Ongoing'}</td>
                            <td data-field="workday_breakTime">${e.breakTime || 0} min</td>
                            <td>${new Date(netTime).toISOString().substr(11, 8)}</td>
                            <td data-field="workday_endOdometer">${e.startOdometer && e.endOdometer ? e.endOdometer - e.startOdometer : '-'} km</td>
                            ${actions}
                        </tr>
                    `;
                });
            } catch (e) { tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">${e.message}</td></tr>`; }
        }

        async function deleteWorkdayEvent(id) {
            if (!confirm('Are you sure you want to delete this workday event?')) return;
            try {
                const res = await fetch(`/api/workday-events/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error((await res.json()).error);
                fetchData();
            } catch (e) { alert(e.message); }
        }

        async function loadRefuelEvents() {
            const tableBody = document.getElementById('refuel-table-body');
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center">Loading...</td></tr>';
            
            const params = new URLSearchParams();
             if(document.getElementById('start-date').value) params.append('startDate', document.getElementById('start-date').value);
            if(document.getElementById('end-date').value) params.append('endDate', document.getElementById('end-date').value);
            if(currentUser.role === 'admin' || currentUser.role === 'superadmin'){
                if(document.getElementById('user-filter')?.value !== 'all') params.append('userId', document.getElementById('user-filter').value);
            }
             if(currentUser.role === 'superadmin' && document.getElementById('company-filter')?.value !== 'all') {
                params.append('companyId', document.getElementById('company-filter').value);
            }

            try {
                const res = await fetch(`/api/refuel-events?${params}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error((await res.json()).error);
                const events = await res.json();
                tableBody.innerHTML = '';
                if(events.length === 0) tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No data found.</td></tr>';
                
                events.forEach(e => {
                    const actions = (currentUser.role === 'superadmin' || e.userId === currentUser.userId) ? 
                        `<td>
                            <button class="btn btn-sm btn-info" onclick="window.location.href='/edit_refuel.html?id=${e.id}'">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRefuelEvent('${e.id}')">Delete</button>
                        </td>` : '<td></td>';

                    tableBody.innerHTML += `
                        <tr>
                            <td data-role-display="admin,superadmin">${e.User?.realName || e.User?.username}</td>
                            <td>${new Date(e.timestamp).toLocaleString()}</td>
                            <td data-field="refuel_location">${e.location || '-'}</td>
                            <td data-field="refuel_odometer">${e.odometer} km</td>
                            <td data-field="workday_carPlate">${e.carPlate || '-'}</td>
                            <td data-field="refuel_fuelType">${e.fuelType}</td>
                            <td>${e.fuelAmount} L</td>
                            <td data-field="refuel_price">${e.value ? e.value.toFixed(2) + ' ' + (companySettings.currency || 'Ft') : '-'}</td>
                            <td data-field="refuel_paymentMethod">${e.paymentMethod}</td>
                            <td>-</td>
                            ${actions}
                        </tr>
                    `;
                });

            } catch (e) { tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">${e.message}</td></tr>`; }
        }

        async function deleteRefuelEvent(id) {
            if (!confirm('Are you sure you want to delete this refuel event?')) return;
            try {
                const res = await fetch(`/api/refuel-events/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (!res.ok) throw new Error((await res.json()).error);
                fetchData();
            } catch (e) { alert(e.message); }
        }
        
        async function handleManualWorkdaySubmit(e) {
            e.preventDefault();
            let userId = currentUser.userId;
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                userId = document.getElementById('manual-user-select').value;
            }
            const body = {
                userId,
                startTime: document.getElementById('manual-start-time').value,
                endTime: document.getElementById('manual-end-time').value || null,
                startLocation: document.getElementById('manual-start-location').value,
                endLocation: document.getElementById('manual-end-location').value,
                carPlate: document.getElementById('manual-car-plate').value,
                startOdometer: document.getElementById('manual-start-odo').value,
                endOdometer: document.getElementById('manual-end-odo').value,
                breakTime: document.getElementById('manual-break').value,
            };

            try {
                const res = await fetch('/api/workday-events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: JSON.stringify(body)
                });
                if(!res.ok) throw new Error((await res.json()).error);
                $('#manualEntryModal').modal('hide');
                fetchData();
            } catch(e) { alert('Error: ' + e.message); }
        }

        async function handleManualRefuelSubmit(e) {
            e.preventDefault();
            let userId = currentUser.userId;
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                userId = document.getElementById('manual-user-select').value;
            }
             const body = {
                userId,
                timestamp: document.getElementById('manual-refuel-date').value,
                odometer: document.getElementById('manual-refuel-odo').value,
                fuelType: document.getElementById('manual-refuel-type').value,
                fuelAmount: document.getElementById('manual-refuel-amount').value,
                price: document.getElementById('manual-refuel-price').value,
                paymentMethod: document.getElementById('manual-refuel-payment').value,
                location: document.getElementById('manual-refuel-location').value
            };
            try {
                const res = await fetch('/api/refuel-events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: JSON.stringify(body)
                });
                if(!res.ok) throw new Error((await res.json()).error);
                $('#manualEntryModal').modal('hide');
                fetchData();
            } catch(e) { alert('Error: ' + e.message); }
        }

    </script>
</body>
</html>
