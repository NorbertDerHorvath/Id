<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Idő - Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { font-size: 0.875rem; }
        .table-responsive { max-height: 400px; }
        th, td { white-space: nowrap; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/dashboard">Idő Dashboard</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto" id="nav-links">
                <li class="nav-item active"><a class="nav-link" href="/dashboard">Home</a></li>
            </ul>
            <ul class="navbar-nav ml-auto">
                 <li class="nav-item"><span class="navbar-text mr-3">Welcome, <span id="username-display"></span>!</span></li>
                <li class="nav-item"><button id="logout-btn" class="btn btn-danger">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div id="main-content">
            <h4>Filters</h4>
            <form class="form-row align-items-end">
                <div class="form-group col-md-3">
                    <label for="start-date">Start Date</label>
                    <input type="date" class="form-control" id="start-date">
                </div>
                <div class="form-group col-md-3">
                    <label for="end-date">End Date</label>
                    <input type="date" class="form-control" id="end-date">
                </div>
                 <div class="form-group col-md-2" id="company-filter-container" style="display: none;">
                    <label for="company-filter">Company</label>
                    <select id="company-filter" class="form-control"></select>
                </div>
                <div class="form-group col-md-2" id="user-filter-container" style="display: none;">
                    <label for="user-filter">User</label>
                    <select id="user-filter" class="form-control"></select>
                </div>
                <div class="form-group col-auto">
                    <button type="button" id="filter-btn" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
    
            <hr>
    
            <h4>Workday Events</h4>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead id="workday-table-head"></thead>
                    <tbody id="workday-table-body"></tbody>
                </table>
            </div>
    
            <h4 class="mt-4">Refuel Events</h4>
            <div class="table-responsive">
                 <table class="table table-sm table-bordered">
                    <thead id="refuel-table-head"></thead>
                    <tbody id="refuel-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let currentUserRole = null;
        let currentSettings = {};
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!token) {
                window.location.href = '/login.html';
                return; 
            }
            main();
        });

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        async function main() {
            const decodedToken = parseJwt(token);
            if (!decodedToken) {
                localStorage.clear();
                window.location.href = '/login.html';
                return;
            }
            currentUserRole = decodedToken.role;
            document.getElementById('username-display').textContent = localStorage.getItem('username') || 'User';

            await loadSettings();

            if (currentUserRole === 'admin' || currentUserRole === 'superadmin') {
                const navLinks = document.getElementById('nav-links');
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>';
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/settings">Settings</a></li>';
                document.getElementById('user-filter-container').style.display = 'block';
                if (currentUserRole === 'superadmin') {
                    document.getElementById('company-filter-container').style.display = 'block';
                    await populateCompanyFilter();
                }
                await populateUserFilter(decodedToken.companyId);
            }

            document.getElementById('filter-btn').addEventListener('click', fetchData);
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = '/login.html';
            });

            fetchData();
        }
        
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings', { headers: { 'Authorization': `Bearer ${token}` }});
                if (!res.ok) throw new Error('Could not load settings');
                currentSettings = await res.json();
            } catch (e) { 
                console.error(e);
                document.getElementById('main-content').innerHTML = `<div class="alert alert-danger"><b>Fatal Error:</b> Could not load company settings. Please contact support.</div>`;
            }
        }

        function fetchData() {
            renderHeaders();
            loadWorkdayEvents();
            loadRefuelEvents();
        }

        function renderHeaders() {
            const workdayHead = document.getElementById('workday-table-head');
            const refuelHead = document.getElementById('refuel-table-head');
            workdayHead.innerHTML = `<tr><th>User</th><th>Plate</th><th>Start</th><th>End</th><th>Breaks</th><th>Net Time</th><th>Distance</th></tr>`;
            refuelHead.innerHTML = `<tr><th>User</th><th>Date</th><th>Location</th><th>Odometer</th><th>Fuel Type</th><th>Amount (L)</th><th>Price</th><th>Payment</th></tr>`;
        }

        async function populateCompanyFilter() {
            try {
                const res = await fetch('/api/companies', { headers: { 'Authorization': `Bearer ${token}` } });
                const companies = await res.json();
                const filter = document.getElementById('company-filter');
                filter.innerHTML = '<option value="all">All Companies</option>';
                companies.forEach(c => { filter.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
            } catch(e) { console.error(e); }
        }

        async function populateUserFilter(companyId) {
             try {
                const res = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${token}` } });
                allUsers = await res.json();
                const userFilter = document.getElementById('user-filter');
                userFilter.innerHTML = '<option value="all">All Users</option>';
                
                let usersToList = (currentUserRole === 'superadmin' && !companyId) ? allUsers : allUsers.filter(u => u.companyId === companyId);
                usersToList.forEach(u => { 
                    userFilter.innerHTML += `<option value="${u.id}">${u.realName || u.username}</option>`;
                });
            } catch(e) { console.error(e); }
        }

        async function loadWorkdayEvents() {
            const tableBody = document.getElementById('workday-table-body');
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center">Loading...</td></tr>`;
            
            const params = new URLSearchParams();
            if(document.getElementById('start-date').value) params.append('startDate', document.getElementById('start-date').value);
            if(document.getElementById('end-date').value) params.append('endDate', document.getElementById('end-date').value);
            if(currentUserRole === 'admin' || currentUserRole === 'superadmin'){
                if(document.getElementById('user-filter')?.value !== 'all') params.append('userId', document.getElementById('user-filter').value);
                if(currentUserRole === 'superadmin' && document.getElementById('company-filter')?.value !== 'all') params.append('companyId', document.getElementById('company-filter').value);
            }

            try {
                const res = await fetch(`/api/workday-events?${params}` , { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error((await res.json()).error || 'Failed to fetch workday events.');
                const events = await res.json();
                tableBody.innerHTML = '';
                if(events.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data found.</td></tr>';
                    return;
                }

                events.forEach(e => {
                    const start = new Date(e.startTime);
                    const end = e.endTime ? new Date(e.endTime) : null;
                    const netTime = end ? (end - start) - (e.breakTime * 60000) : 0;
                    tableBody.innerHTML += `
                        <tr>
                            <td>${e.User?.realName || e.User?.username}</td>
                            <td>${e.carPlate || '-'}</td>
                            <td>${start.toLocaleString()} - ${e.startLocation || '-'} (${e.startOdometer || '-'} km)</td>
                            <td>${end ? `${end.toLocaleString()} - ${e.endLocation || '-'} (${e.endOdometer || '-'} km)` : 'Ongoing'}</td>
                            <td>${e.breakTime || 0} min</td>
                            <td>${new Date(netTime).toISOString().substr(11, 8)}</td>
                            <td>${e.startOdometer && e.endOdometer ? e.endOdometer - e.startOdometer : '-'} km</td>
                        </tr>
                    `;
                });
            } catch (e) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${e.message}</td></tr>`; }
        }

        async function loadRefuelEvents() {
            const tableBody = document.getElementById('refuel-table-body');
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center">Loading...</td></tr>`;
            const currency = currentSettings.companySettings?.currency || 'Ft';
            const params = new URLSearchParams();
             if(document.getElementById('start-date').value) params.append('startDate', document.getElementById('start-date').value);
            if(document.getElementById('end-date').value) params.append('endDate', document.getElementById('end-date').value);
            if(currentUserRole === 'admin' || currentUserRole === 'superadmin'){
                if(document.getElementById('user-filter')?.value !== 'all') params.append('userId', document.getElementById('user-filter').value);
                if(currentUserRole === 'superadmin' && document.getElementById('company-filter')?.value !== 'all') params.append('companyId', document.getElementById('company-filter').value);
            }

            try {
                const res = await fetch(`/api/refuel-events?${params}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error((await res.json()).error || 'Failed to fetch refuel events.');
                const events = await res.json();
                tableBody.innerHTML = '';
                if(events.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No data found.</td></tr>';
                    return;
                }
                
                events.forEach(e => {
                    tableBody.innerHTML += `
                        <tr>
                            <td>${e.User?.realName || e.User?.username}</td>
                            <td>${new Date(e.timestamp).toLocaleString()}</td>
                            <td>${e.location || '-'}</td>
                            <td>${e.odometer} km</td>
                            <td>${e.fuelType}</td>
                            <td>${e.fuelAmount} L</td>
                            <td>${e.value ? e.value.toFixed(2) + ' ' + currency : '-'}</td>
                            <td>${e.paymentMethod}</td>
                        </tr>
                    `;
                });

            } catch (e) { tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">${e.message}</td></tr>`; }
        }
    </script>
</body>
</html>
