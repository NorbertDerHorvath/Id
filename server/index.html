<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Id≈ë - Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { font-size: 0.875rem; }
        .table-responsive { max-height: 400px; }
        th, td { white-space: nowrap; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">... </nav>

    <div class="container-fluid mt-4">
        <div id="main-content">
            <!-- Content will be generated by JavaScript -->
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let currentUserRole = null;
        let currentSettings = {};
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (!token) {
                window.location.href = '/login.html';
                return; 
            }
            main();
        });

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        async function main() {
            const decodedToken = parseJwt(token);
            if (!decodedToken) {
                localStorage.clear();
                window.location.href = '/login.html';
                return;
            }
            currentUserRole = decodedToken.role;
            document.getElementById('username-display').textContent = localStorage.getItem('username') || 'User';

            // Load settings first, as they determine what to display
            await loadSettings(decodedToken.companyId);
            
            // Now build the UI
            buildUI(decodedToken);
            
            // Then fetch the data
            fetchData();
        }
        
        async function loadSettings(companyId) {
            // Superadmin might not have a company, which is fine.
            // We only fetch settings if a companyId is available.
            if (!companyId && currentUserRole !== 'superadmin') {
                 document.getElementById('main-content').innerHTML = `<div class="alert alert-danger"><b>Error:</b> User is not assigned to a company.</div>`;
                 return;
            }
            try {
                 // Superadmin dashboard will use default settings until a company is selected in filters.
                const targetCompanyId = currentUserRole === 'superadmin' ? document.getElementById('company-filter')?.value : companyId;
                if (!targetCompanyId || targetCompanyId === 'all') {
                    currentSettings = { companySettings: { currency: 'HUF', visibleFields: {}, customFields: [] } };
                    return;
                }

                const res = await fetch(`/api/settings?companyId=${targetCompanyId}`, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!res.ok) throw new Error('Could not load settings');
                currentSettings = await res.json();
            } catch (e) { 
                console.error(e);
                document.getElementById('main-content').innerHTML = `<div class="alert alert-danger"><b>Fatal Error:</b> Could not load company settings. Please contact support.</div>`;
            }
        }

        function buildUI(decodedToken) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h4>Filters</h4>
                <form class="form-row align-items-end">
                    <div class="form-group col-md-3">
                        <label for="start-date">Start Date</label>
                        <input type="date" class="form-control" id="start-date">
                    </div>
                    <div class="form-group col-md-3">
                        <label for="end-date">End Date</label>
                        <input type="date" class="form-control" id="end-date">
                    </div>
                     <div class="form-group col-md-2" id="company-filter-container" style="display: none;">
                        <label for="company-filter">Company</label>
                        <select id="company-filter" class="form-control"></select>
                    </div>
                    <div class="form-group col-md-2" id="user-filter-container" style="display: none;">
                        <label for="user-filter">User</label>
                        <select id="user-filter" class="form-control"></select>
                    </div>
                    <div class="form-group col-auto">
                        <button type="button" id="filter-btn" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
                <hr>
                <h4>Workday Events</h4>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead id="workday-table-head"></thead>
                        <tbody id="workday-table-body"></tbody>
                    </table>
                </div>
                <h4 class="mt-4">Refuel Events</h4>
                <div class="table-responsive">
                     <table class="table table-sm table-bordered">
                        <thead id="refuel-table-head"></thead>
                        <tbody id="refuel-table-body"></tbody>
                    </table>
                </div>
            `;

            if (currentUserRole === 'admin' || currentUserRole === 'superadmin') {
                const navLinks = document.getElementById('nav-links');
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>';
                navLinks.innerHTML += '<li class="nav-item"><a class="nav-link" href="/settings">Settings</a></li>';
                document.getElementById('user-filter-container').style.display = 'block';
                if (currentUserRole === 'superadmin') {
                    document.getElementById('company-filter-container').style.display = 'block';
                    populateCompanyFilter();
                }
                populateUserFilter(decodedToken.companyId);
            }
            
            document.getElementById('filter-btn').addEventListener('click', fetchData);
             document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = '/login.html';
            });
        }

        // ... rest of the functions like fetchData, populateFilters, loadEvents etc.
    </script>
</body>
</html>
